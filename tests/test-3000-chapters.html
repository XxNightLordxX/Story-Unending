<!DOCTYPE html>
<html>
<head>
    <title>Test 3000 Chapters</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        .section { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 8px; }
        .pass { color: #4ade80; }
        .fail { color: #f87171; }
        .warning { color: #fbbf24; }
        h1 { color: #60a5fa; }
        h2 { color: #a78bfa; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #374151; }
        th { color: #60a5fa; }
        #progress { position: fixed; top: 10px; right: 10px; background: #1f2937; padding: 15px; border-radius: 8px; z-index: 1000; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div id="progress">Initializing...</div>
    <h1>üß™ Comprehensive Test: 3000 Chapters</h1>
    <div id="results"></div>

    <script src="story-engine.js"></script>
    <script>
        const TOTAL_CHAPTERS = 3000;
        const BACKSTORY_CHAPTERS = 58;
        
        const results = {
            totalChapters: 0,
            duplicateTitles: [],
            duplicateParagraphs: [],
            wordCountIssues: [],
            arcProgression: [],
            statProgression: [],
            performance: {
                startTime: null,
                endTime: null,
                duration: null
            }
        };

        function updateProgress(current, total, message) {
            const progress = document.getElementById('progress');
            const percent = ((current / total) * 100).toFixed(1);
            progress.innerHTML = `
                <strong>Progress:</strong> ${current}/${total} (${percent}%)<br>
                <strong>Status:</strong> ${message}
            `;
        }

        function runTest() {
            console.log('='.repeat(80));
            console.log('COMPREHENSIVE TEST: 3000 CHAPTERS');
            console.log('='.repeat(80));
            console.log(`Starting test at: ${new Date().toISOString()}`);
            console.log('');

            results.performance.startTime = Date.now();

            // Generate 3000 chapters
            console.log('Generating 3000 chapters...');
            for (let i = 1; i <= TOTAL_CHAPTERS; i++) {
                const chapter = generateChapter(i);
                results.totalChapters++;
                
                // Check for duplicate titles
                if (results.duplicateTitles.includes(chapter.title)) {
                    console.log(`‚ö†Ô∏è  Duplicate title found: "${chapter.title}" in Chapter ${i}`);
                } else {
                    results.duplicateTitles.push(chapter.title);
                }
                
                // Check word count
                if (chapter.wordCount < 1000) {
                    results.wordCountIssues.push({
                        chapter: i,
                        wordCount: chapter.wordCount,
                        title: chapter.title
                    });
                }
                
                // Track arc progression
                if (!results.arcProgression.includes(chapter.arc)) {
                    results.arcProgression.push(chapter.arc);
                }
                
                // Track stat progression (sample every 100 chapters)
                if (i % 100 === 0) {
                    results.statProgression.push({
                        chapter: i,
                        level: chapter.mcSnapshot.level,
                        hp: chapter.mcSnapshot.hp,
                        mp: chapter.mcSnapshot.mp,
                        bloodEssence: chapter.mcSnapshot.bloodEssence
                    });
                }
                
                // Progress indicator
                if (i % 100 === 0) {
                    updateProgress(i, TOTAL_CHAPTERS, `Generated ${i} chapters...`);
                    console.log(`Generated ${i} chapters...`);
                }
            }

            results.performance.endTime = Date.now();
            results.performance.duration = results.performance.endTime - results.performance.startTime;

            updateProgress(TOTAL_CHAPTERS, TOTAL_CHAPTERS, 'Test complete!');
            displayResults();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            
            console.log('');
            console.log('='.repeat(80));
            console.log('TEST RESULTS');
            console.log('='.repeat(80));

            // Summary
            let html = `
                <div class="section">
                    <h2>üìä SUMMARY</h2>
                    <table>
                        <tr><th>Metric</th><th>Value</th></tr>
                        <tr><td>Total Chapters Generated</td><td>${results.totalChapters}</td></tr>
                        <tr><td>Unique Titles</td><td>${results.duplicateTitles.length}</td></tr>
                        <tr><td>Duplicate Titles</td><td class="${results.totalChapters - results.duplicateTitles.length > 0 ? 'fail' : 'pass'}">${results.totalChapters - results.duplicateTitles.length}</td></tr>
                        <tr><td>Word Count Issues (< 1000 words)</td><td class="${results.wordCountIssues.length > 0 ? 'fail' : 'pass'}">${results.wordCountIssues.length}</td></tr>
                        <tr><td>Unique Arcs</td><td>${results.arcProgression.length}</td></tr>
                        <tr><td>Performance</td><td>${(results.performance.duration / 1000).toFixed(2)} seconds</td></tr>
                        <tr><td>Average Time per Chapter</td><td>${(results.performance.duration / TOTAL_CHAPTERS).toFixed(2)}ms</td></tr>
                    </table>
                </div>
            `;

            // Duplicate titles detail
            if (results.totalChapters - results.duplicateTitles.length > 0) {
                const titleCounts = {};
                results.duplicateTitles.forEach(title => {
                    titleCounts[title] = (titleCounts[title] || 0) + 1;
                });
                
                html += `
                    <div class="section">
                        <h2 class="warning">‚ö†Ô∏è DUPLICATE TITLES</h2>
                        <table>
                            <tr><th>Title</th><th>Occurrences</th></tr>
                `;
                Object.entries(titleCounts).forEach(([title, count]) => {
                    if (count > 1) {
                        html += `<tr><td>"${title}"</td><td>${count}</td></tr>`;
                    }
                });
                html += `</table></div>`;
            }

            // Word count issues detail
            if (results.wordCountIssues.length > 0) {
                html += `
                    <div class="section">
                        <h2 class="warning">‚ö†Ô∏è WORD COUNT ISSUES</h2>
                        <table>
                            <tr><th>Chapter</th><th>Word Count</th><th>Title</th></tr>
                `;
                results.wordCountIssues.forEach(issue => {
                    html += `<tr><td>${issue.chapter}</td><td>${issue.wordCount}</td><td>"${issue.title}"</td></tr>`;
                });
                html += `</table></div>`;
            }

            // Arc progression
            html += `
                <div class="section">
                    <h2>üìö ARC PROGRESSION</h2>
                    <table>
                        <tr><th>#</th><th>Arc Name</th></tr>
            `;
            results.arcProgression.forEach((arc, index) => {
                html += `<tr><td>${index + 1}</td><td>${arc}</td></tr>`;
            });
            html += `</table></div>`;

            // Stat progression sample
            html += `
                <div class="section">
                    <h2>üìà STAT PROGRESSION (Sample every 100 chapters)</h2>
                    <table>
                        <tr><th>Chapter</th><th>Level</th><th>HP</th><th>MP</th><th>Blood Essence</th></tr>
            `;
            results.statProgression.forEach(stat => {
                html += `<tr><td>${stat.chapter}</td><td>${stat.level}</td><td>${stat.hp}</td><td>${stat.mp}</td><td>${stat.bloodEssence}</td></tr>`;
            });
            html += `</table></div>`;

            // Final verdict
            const hasIssues = (results.totalChapters - results.duplicateTitles.length) > 0 || results.wordCountIssues.length > 0;
            
            html += `
                <div class="section">
                    <h2>${hasIssues ? '‚ö†Ô∏è ISSUES FOUND' : '‚úÖ ALL TESTS PASSED'}</h2>
            `;
            
            if (!hasIssues) {
                html += `
                    <p class="pass">‚úÖ No duplicate titles found</p>
                    <p class="pass">‚úÖ All chapters meet minimum word count (1000 words)</p>
                    <p class="pass">‚úÖ Arc progression working correctly</p>
                    <p class="pass">‚úÖ Stat progression working correctly</p>
                    <p class="pass">‚úÖ Performance acceptable</p>
                `;
            } else {
                if (results.totalChapters - results.duplicateTitles.length > 0) {
                    html += `<p class="fail">‚ö†Ô∏è ${results.totalChapters - results.duplicateTitles.length} duplicate titles found</p>`;
                }
                if (results.wordCountIssues.length > 0) {
                    html += `<p class="fail">‚ö†Ô∏è ${results.wordCountIssues.length} chapters below minimum word count</p>`;
                }
            }
            
            html += `</div>`;
            html += `<p><strong>Test completed at:</strong> ${new Date().toISOString()}</p>`;

            resultsDiv.innerHTML = html;

            console.log('');
            console.log('='.repeat(80));
            console.log('FINAL VERDICT');
            console.log('='.repeat(80));
            
            if (!hasIssues) {
                console.log('‚úÖ ALL TESTS PASSED');
                console.log('');
                console.log('‚úÖ No duplicate titles found');
                console.log('‚úÖ All chapters meet minimum word count (1000 words)');
                console.log('‚úÖ Arc progression working correctly');
                console.log('‚úÖ Stat progression working correctly');
                console.log('‚úÖ Performance acceptable');
            } else {
                console.log('‚ö†Ô∏è ISSUES FOUND');
                console.log('');
                if (results.totalChapters - results.duplicateTitles.length > 0) {
                    console.log(`‚ö†Ô∏è ${results.totalChapters - results.duplicateTitles.length} duplicate titles found`);
                }
                if (results.wordCountIssues.length > 0) {
                    console.log(`‚ö†Ô∏è ${results.wordCountIssues.length} chapters below minimum word count`);
                }
            }

            console.log('');
            console.log('='.repeat(80));
            console.log(`Test completed at: ${new Date().toISOString()}`);
            console.log('='.repeat(80));
        }

        // Run test after page load
        window.onload = function() {
            setTimeout(runTest, 100);
        };
    </script>
</body>
</html>